name: Train Cat-Dog Classifier

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  train:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Install additional tools
      run: |
        pip install kaggle gdown
        
    # é¸é …1: å¾ Kaggle ä¸‹è¼‰æ•¸æ“šé›†
    - name: Download dataset from Kaggle
      env:
        KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
        KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
      run: |
        # å‰µå»º Kaggle é…ç½®ç›®éŒ„
        mkdir -p ~/.kaggle
        echo '{"username":"'$KAGGLE_USERNAME'","key":"'$KAGGLE_KEY'"}' > ~/.kaggle/kaggle.json
        chmod 600 ~/.kaggle/kaggle.json
        
        # ä¸‹è¼‰ä¸¦è§£å£“æ•¸æ“šé›†
        kaggle datasets download -d salader/dogs-vs-cats
        unzip -q dogs-vs-cats.zip -d ./
        
        # å‰µå»ºæ‰€éœ€çš„ç›®éŒ„çµæ§‹
        mkdir -p kaggle_cats_vs_dogs_f/train/cat
        mkdir -p kaggle_cats_vs_dogs_f/train/dog  
        mkdir -p kaggle_cats_vs_dogs_f/val/cat
        mkdir -p kaggle_cats_vs_dogs_f/val/dog
        
        # ç§»å‹•å’Œåˆ†å‰²æ•¸æ“š
        python scripts/prepare_dataset.py
      if: env.KAGGLE_USERNAME != '' && env.KAGGLE_KEY != ''
        
    # é¸é …2: å¾ Google Drive ä¸‹è¼‰æ•¸æ“šé›† (å‚™ç”¨é¸é …)
    - name: Download dataset from Google Drive
      run: |
        # è«‹æ›¿æ› FILE_ID ç‚ºä½ çš„ Google Drive æ–‡ä»¶ ID
        # gdown https://drive.google.com/uc?id=19QvyV00Zq6dwRY3hA8z_PyHB-naUUMB7
        # unzip -q dataset.zip -d ./
        echo "å¦‚æœéœ€è¦å¾ Google Drive ä¸‹è¼‰ï¼Œè«‹å–æ¶ˆè¨»é‡‹ä¸¦è¨­ç½®æ­£ç¢ºçš„æ–‡ä»¶ ID"
      if: env.KAGGLE_USERNAME == '' || env.KAGGLE_KEY == ''
        
    - name: Verify dataset structure
      run: |
        echo "æª¢æŸ¥æ•¸æ“šé›†çµæ§‹..."
        ls -la kaggle_cats_vs_dogs_f/
        echo "è¨“ç·´é›†:"
        ls -la kaggle_cats_vs_dogs_f/train/
        echo "é©—è­‰é›†:"
        ls -la kaggle_cats_vs_dogs_f/val/
        
        # è¨ˆç®—æ–‡ä»¶æ•¸é‡
        echo "è¨“ç·´é›†è²“å’ªåœ–ç‰‡æ•¸é‡: $(find kaggle_cats_vs_dogs_f/train/cat -name "*.jpg" | wc -l)"
        echo "è¨“ç·´é›†ç‹—ç‹—åœ–ç‰‡æ•¸é‡: $(find kaggle_cats_vs_dogs_f/train/dog -name "*.jpg" | wc -l)"
        echo "é©—è­‰é›†è²“å’ªåœ–ç‰‡æ•¸é‡: $(find kaggle_cats_vs_dogs_f/val/cat -name "*.jpg" | wc -l)"
        echo "é©—è­‰é›†ç‹—ç‹—åœ–ç‰‡æ•¸é‡: $(find kaggle_cats_vs_dogs_f/val/dog -name "*.jpg" | wc -l)"
        
    - name: Train model
      run: |
        echo "é–‹å§‹è¨“ç·´æ¨¡å‹..."
        python train_model.py
        
    - name: Test model predictions
      run: |
        echo "æ¸¬è©¦æ¨¡å‹é æ¸¬..."
        # å‰µå»ºæ¸¬è©¦åœ–ç‰‡ç›®éŒ„
        mkdir -p test_images
        
        # è¤‡è£½ä¸€äº›é©—è­‰åœ–ç‰‡ç”¨æ–¼æ¸¬è©¦
        cp kaggle_cats_vs_dogs_f/val/cat/*.jpg test_images/ 2>/dev/null || true
        cp kaggle_cats_vs_dogs_f/val/dog/*.jpg test_images/ 2>/dev/null || true
        
        # é€²è¡Œæ‰¹æ¬¡é æ¸¬æ¸¬è©¦
        python predict.py --model best_cat_dog_model.pth --folder test_images/
        
    - name: Generate model summary
      run: |
        echo "ç”Ÿæˆæ¨¡å‹æ‘˜è¦..."
        python -c "
        import torch
        import os
        
        if os.path.exists('best_cat_dog_model.pth'):
            checkpoint = torch.load('best_cat_dog_model.pth', map_location='cpu')
            print(f'æ¨¡å‹é¡åˆ¥: {checkpoint[\"class_names\"]}')
            print(f'æ¨¡å‹æ¶æ§‹: {checkpoint[\"model_architecture\"]}')
            
            # è¨ˆç®—æ¨¡å‹å¤§å°
            model_size = os.path.getsize('best_cat_dog_model.pth') / (1024*1024)
            print(f'æ¨¡å‹å¤§å°: {model_size:.2f} MB')
        else:
            print('æœªæ‰¾åˆ°è¨“ç·´å¥½çš„æ¨¡å‹æ–‡ä»¶')
        "
        
    - name: Upload trained model
      uses: actions/upload-artifact@v4
      with:
        name: trained-cat-dog-model
        path: |
          best_cat_dog_model.pth
          training_curves.png
        retention-days: 30
        
    - name: Upload training logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: training-logs
        path: |
          *.log
          *.txt
        retention-days: 7

  deploy:
    needs: train
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download trained model
      uses: actions/download-artifact@v4
      with:
        name: trained-cat-dog-model
        path: ./models/
        
    - name: Create release
      if: success()
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: model-v${{ github.run_number }}
        name: Cat-Dog Classifier Model v${{ github.run_number }}
        body: |
          ğŸ±ğŸ¶ è‡ªå‹•è¨“ç·´çš„è²“ç‹—åˆ†é¡å™¨æ¨¡å‹
          
          **è¨“ç·´ä¿¡æ¯:**
          - æ¨¡å‹æ¶æ§‹: ResNet18
          - è¨“ç·´æ™‚é–“: ${{ github.run_started_at }}
          - Commit: ${{ github.sha }}
          
          **ä½¿ç”¨æ–¹æ³•:**
          ```bash
          python predict.py --model best_cat_dog_model.pth --image your_image.jpg
          ```
        files: |
          ./models/best_cat_dog_model.pth
          ./models/training_curves.png
        draft: false
        prerelease: false
